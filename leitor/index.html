<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Gabaritos (Foto para CSV - AI Vision)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 800px; 
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }
        h1 { color: #333; }
        input[type="file"], input[type="text"], input[type="number"] {
            margin: 10px 0;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        input[type="text"]:disabled { background-color: #e9ecef; color: #6c757d; }
        #gabarito-preview {
            max-width: 100%;
            max-height: 500px; 
            margin-top: 15px;
            border: 2px solid #ddd;
            display: none;
        }
        #resultado {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #007bff;
            background-color: #e9f5ff;
            color: #007bff;
            border-radius: 5px;
            text-align: left;
            transition: background-color 0.3s;
        }
        .button-group { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        #btn-definir-estrutura { background-color: #007bff; color: white; }
        #btn-definir-estrutura:hover { background-color: #0056b3; }
        
        #encerrar-gabaritos { background-color: #dc3545; color: white; width: 100%; margin-top: 30px; }
        #encerrar-gabaritos:hover { background-color: #c82333; }
        #encerrar-gabaritos:disabled, button:disabled { background-color: #f4f4f9; color: #6c757d; cursor: not-allowed; }

        /* Estilos para as Se√ß√µes */
        #config-section, #gabarito-oficial-section, #input-section {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: left;
        }
        #input-section { display: none; }
        /* Layout de 5 em 5 para o Gabarito Oficial */
        #gabarito-respostas-area {
            display: grid;
            grid-template-columns: repeat(5, 1fr); 
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Nova Se√ß√£o de Confirma√ß√£o */
        #leitura-confirmacao {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #ffc107;
            background-color: #fff8e1;
            border-radius: 8px;
            display: none;
        }
        #leitura-confirmacao-respostas {
            font-size: 0.9em;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
            text-align: left;
        }
        #btn-confirmar-leitura { background-color: #28a745; color: white; }
        #btn-reenviar-imagem { background-color: #ffc107; color: #333; } 
        #btn-corrigir-manual { background-color: #ffc107; color: #333; } 
        
        /* Nova √Årea de Corre√ß√£o Manual */
        #correcao-manual-area {
            margin-top: 20px; 
            display: none; 
            padding: 15px; 
            border: 1px dashed #ffc107;
        }
        #inputs-correcao-manual {
            /* Layout de 5 em 5 para a Corre√ß√£o Manual */
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 10px;
        }
        /* NOVO CSS: Esconder o grupo de bot√µes de confirma√ß√£o/reenvio durante a edi√ß√£o */
        .confirmation-buttons-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        /* Garante que o Confirmar Leitura seja vis√≠vel mesmo na edi√ß√£o */
        .correction-buttons-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ Leitor de Gabaritos</h1>

        <div id="config-section">
            <h3>1. Configura√ß√£o da Prova</h3>
            <p>Informe a estrutura da prova.</p>
            <input type="number" id="num-questoes" placeholder="N√∫mero de Quest√µes (Ex: 50)" min="1" required>
            <input type="number" id="num-alternativas" placeholder="N√∫mero de Alternativas (Ex: 5)" min="2" max="5" required>
		<input type="number" id="num-pontos-referencia" value="4" disabled style="background-color: #f0f0f0; display: none;" title="O modelo de gabarito usa 4 pontos de refer√™ncia fixos;" required>            
            <input type="text" id="turma-input" placeholder="Turma (Ex: 8A, 3¬∫ Ano B)" required>

            <button id="btn-definir-estrutura" disabled style="width: 100%; margin-top: 15px;">Definir Estrutura</button>
        </div>

        <div id="gabarito-oficial-section" style="display: none; margin-bottom: 20px;">
             <h3>2. Gabarito Oficial</h3>
             <p>Preencha as respostas corretas. (Exibi√ß√£o: 5 quest√µes por linha)</p>
             <div id="gabarito-respostas-area">
                </div>
             <button id="btn-iniciar-leitura" disabled style="width: 100%; margin-top: 15px; background-color: #28a745;">Iniciar Leitura dos Alunos</button>
        </div>

        <div id="input-section">
            <h3>3. Leitura dos Gabaritos</h3>
            
            <input type="text" id="aluno-input" placeholder="Nome Completo do Aluno" required>

            <input type="file" id="gabarito-input" accept="image/*">
            <img id="gabarito-preview" alt="Pr√©-visualiza√ß√£o do Gabarito" style="border: 2px solid #ddd;">

            <div id="resultado" style="background-color: #e9f5ff; border-color: #007bff; color: #007bff;">
                Preencha o nome do aluno e carregue a imagem do gabarito para iniciar a an√°lise autom√°tica.
            </div>

            <div id="leitura-confirmacao">
                <h4>‚ö†Ô∏è CONFIRME A LEITURA</h4>
                <p>Verifique abaixo se as respostas lidas pela IA est√£o corretas (Exibi√ß√£o: 5 quest√µes por linha):</p>
                <div id="leitura-confirmacao-respostas"></div>
                
                <div id="confirmation-buttons-row" class="confirmation-buttons-row">
                    <button id="btn-confirmar-leitura-normal" style="background-color: #28a745; color: white;">‚úÖ Confirmar Leitura Correta</button>
                    <button id="btn-corrigir-manual">‚úçÔ∏è Corrigir Leitura (Manual)</button> 
                    <button id="btn-reenviar-imagem">üîÑ Reenviar Imagem</button>
                </div>
                
                <div id="correcao-manual-area">
                    <h4>Edi√ß√£o Manual de Respostas:</h4>
                    <div id="inputs-correcao-manual">
                        </div>
                    <div id="correction-buttons-row" class="correction-buttons-row">
                        <button id="btn-confirmar-leitura-manual" style="background-color: #007bff; color: white;">üíæ Salvar e Confirmar Altera√ß√µes</button>
                    </div>
                </div>

            </div>
            <p style="margin-top: 15px; text-align: center; color: #6c757d;">Alunos processados: <span id="alunos-count">0</span></p>

            <button id="encerrar-gabaritos" disabled>Encerrar Gabaritos da Turma (Gerar CSV)</button>
        </div>

        <canvas id="process-canvas"></canvas>
    </div>

    <a href="https://relatoriotri.vercel.app/" style="margin-top: 20px; display: inline-block;">‚Ü©Ô∏è Voltar para a P√°gina de An√°lise de Resultados</a>
    
    <script>
        // Vari√°veis de UI
        const turmaInput = document.getElementById('turma-input');
        const alunoInput = document.getElementById('aluno-input');
        const gabaritoInput = document.getElementById('gabarito-input');
        const gabaritoPreview = document.getElementById('gabarito-preview');
        const resultadoDiv = document.getElementById('resultado');
        const encerrarBtn = document.getElementById('encerrar-gabaritos');
        const alunosCountSpan = document.getElementById('alunos-count');
        const numQuestoesInput = document.getElementById('num-questoes');
        const numAlternativasInput = document.getElementById('num-alternativas');
        const definirEstruturaBtn = document.getElementById('btn-definir-estrutura');
        const configSection = document.getElementById('config-section');
        const gabaritoOficialSection = document.getElementById('gabarito-oficial-section');
        const gabaritoRespostasArea = document.getElementById('gabarito-respostas-area');
        const iniciarLeituraBtn = document.getElementById('btn-iniciar-leitura');
        const inputSection = document.getElementById('input-section');
        
        // Elementos de confirma√ß√£o e corre√ß√£o
        const leituraConfirmacaoDiv = document.getElementById('leitura-confirmacao');
        const confirmacaoRespostasDiv = document.getElementById('leitura-confirmacao-respostas');
        const confirmarLeituraNormalBtn = document.getElementById('btn-confirmar-leitura-normal'); // Bot√£o normal
        const confirmarLeituraManualBtn = document.getElementById('btn-confirmar-leitura-manual'); // NOVO: Bot√£o para salvar ap√≥s edi√ß√£o
        const reenviarImagemBtn = document.getElementById('btn-reenviar-imagem');
        const corrigirManualBtn = document.getElementById('btn-corrigir-manual'); 
        const correcaoManualArea = document.getElementById('correcao-manual-area'); 
        const inputsCorrecaoManual = document.getElementById('inputs-correcao-manual'); 
        const confirmationButtonsRow = document.getElementById('confirmation-buttons-row'); // Linha de bot√µes normal
        const correctionButtonsRow = document.getElementById('correction-buttons-row'); // Linha de bot√µes de edi√ß√£o


        // Vari√°veis de Estado
        let dadosGabaritos = [];
        let gabaritoOficialRespostas = [];
        let NUM_QUESTOES = 0;
        let NUM_ALTERNATIVAS = 0;
        
        // Estado tempor√°rio para a confirma√ß√£o
        let alunoEmProcessamento = '';
        let respostasTemporarias = {};
        let isProcessing = false; 

        // --- FUN√á√ÉO HELPER: LER ARQUIVO COMO BASE64 ---
        function getFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    return reject(new Error("Nenhum arquivo fornecido."));
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }


        // --- B. CONFIGURA√á√ÉO E DEFINI√á√ÉO DO GABARITO OFICIAL ---
        numQuestoesInput.addEventListener('input', validarConfig);
        numAlternativasInput.addEventListener('input', validarConfig);
        turmaInput.addEventListener('input', validarConfig);
        
        function validarConfig() {
            const numQ = parseInt(numQuestoesInput.value);
            const numA = parseInt(numAlternativasInput.value);
            const turmaValida = turmaInput.value.trim() !== '';
            
            if (numQ >= 1 && numA >= 2 && numA <= 5 && turmaValida) {
                definirEstruturaBtn.disabled = false;
            } else {
                definirEstruturaBtn.disabled = true;
            }
        }

        definirEstruturaBtn.addEventListener('click', function() {
            NUM_QUESTOES = parseInt(numQuestoesInput.value);
            NUM_ALTERNATIVAS = parseInt(numAlternativasInput.value);
            
            renderizarInputsGabaritoOficial();
            
            configSection.style.display = 'none';
            gabaritoOficialSection.style.display = 'block';
        });

        function renderizarInputsGabaritoOficial() {
            gabaritoRespostasArea.innerHTML = '';
            
            const alternativas = ['A', 'B', 'C', 'D', 'E'].slice(0, NUM_ALTERNATIVAS);

            for (let i = 1; i <= NUM_QUESTOES; i++) {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label for="q${i}" style="font-weight: bold;">Q${i}:</label>
                    <select id="q${i}" required style="width: 100%; padding: 8px;">
                        <option value="">--</option>
                        ${alternativas.map(alt => `<option value="${alt}">${alt}</option>`).join('')}
                    </select>
                `;
                gabaritoRespostasArea.appendChild(div);
            }
            
            gabaritoRespostasArea.addEventListener('change', validarGabaritoOficial);
            validarGabaritoOficial();
        }
        
        function validarGabaritoOficial() {
            const selects = gabaritoRespostasArea.querySelectorAll('select');
            let preenchido = true;
            selects.forEach(select => {
                if (select.value === "") {
                    preenchido = false;
                }
            });
            iniciarLeituraBtn.disabled = !preenchido;
            resultadoDiv.textContent = "Preencha todas as respostas corretas para iniciar a leitura dos alunos.";
        }

        iniciarLeituraBtn.addEventListener('click', function() {
            gabaritoOficialRespostas = [];
            const selects = gabaritoRespostasArea.querySelectorAll('select');
            selects.forEach(select => {
                gabaritoOficialRespostas.push(select.value);
            });
            
            turmaInput.disabled = true;
            gabaritoOficialSection.style.display = 'none';
            inputSection.style.display = 'block';
            resultadoDiv.textContent = `Gabarito Oficial (Q1-Q${NUM_QUESTOES}) definido. Turma ${turmaInput.value} travada. Preencha o nome do aluno e carregue a imagem.`;
            resultadoDiv.style.display = 'block'; 
        });

        // --- C. L√ìGICA DE INPUT E IN√çCIO DE PROCESSAMENTO AUTOM√ÅTICO ---
        
        alunoInput.addEventListener('input', function() {
            const alunoValido = alunoInput.value.trim() !== '';
            const imagemSelecionada = gabaritoInput.files && gabaritoInput.files.length > 0;
            
            if (alunoValido && imagemSelecionada && !isProcessing && leituraConfirmacaoDiv.style.display === 'none') {
                resultadoDiv.textContent = `A imagem para ${alunoInput.value.trim()} foi carregada. Iniciando an√°lise autom√°tica...`;
                resultadoDiv.style.backgroundColor = '#d4edda';
                resultadoDiv.style.borderColor = '#c3e6cb';
                resultadoDiv.style.color = '#155724';
                setTimeout(processarGabaritoImediatamente, 50);
            } else if (imagemSelecionada && !alunoValido) {
                 resultadoDiv.textContent = "Nome do aluno ausente. Por favor, preencha o nome para iniciar o processamento autom√°tico.";
                 resultadoDiv.style.backgroundColor = '#fff3cd';
                 resultadoDiv.style.color = '#856404';
            }
        });

        gabaritoInput.addEventListener('change', function() {
            const file = this.files[0];
            const alunoValido = alunoInput.value.trim() !== '';
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    gabaritoPreview.src = e.target.result;
                    gabaritoPreview.style.display = 'block';
                }
                reader.readAsDataURL(file); 
                
                if (alunoValido && !isProcessing) {
                    resultadoDiv.textContent = `A imagem para ${alunoInput.value.trim()} foi carregada. Iniciando an√°lise autom√°tica...`;
                    resultadoDiv.style.backgroundColor = '#d4edda';
                    resultadoDiv.style.borderColor = '#c3e6cb';
                    resultadoDiv.style.color = '#155724';
                    setTimeout(processarGabaritoImediatamente, 50); 
                } else if (!alunoValido) {
                     resultadoDiv.textContent = "Nome do aluno ausente. Por favor, preencha o nome para iniciar o processamento autom√°tico.";
                     resultadoDiv.style.backgroundColor = '#fff3cd';
                     resultadoDiv.style.color = '#856404';
                }
            } else {
                gabaritoPreview.style.display = 'none';
                resultadoDiv.textContent = "Preencha o nome do aluno e carregue a imagem do gabarito para iniciar a an√°lise autom√°tica.";
                resultadoDiv.style.backgroundColor = '#e9f5ff';
                resultadoDiv.style.color = '#007bff';
            }
        });

        function validarFormularioAluno() { }
        
        async function processarGabaritoImediatamente() {
            if (isProcessing) return; 
            
            isProcessing = true;
            encerrarBtn.disabled = true; 
            
            const turma = turmaInput.value.trim();
            alunoEmProcessamento = alunoInput.value.trim();
            const file = gabaritoInput.files[0];

            if (!alunoEmProcessamento || !file) {
                 resultadoDiv.textContent = "Erro: Por favor, preencha o nome do aluno e envie a imagem.";
                 isProcessing = false;
                 return;
            }
            
            resultadoDiv.textContent = `Processando gabarito de ${alunoEmProcessamento} (${turma}). Lendo arquivo e convertendo para Base64...`;
            resultadoDiv.style.backgroundColor = '#e9f5ff';
            resultadoDiv.style.color = '#007bff';
            
            try {
                const gabaritoParaProcessar = await getFileAsBase64(file);
                
                if (typeof gabaritoParaProcessar !== 'string' || !gabaritoParaProcessar.startsWith('data:image')) {
                     throw new Error("Erro na convers√£o Base64.");
                }

                resultadoDiv.textContent = `Enviando gabarito de ${alunoEmProcessamento} para a Intelig√™ncia Artificial (Gemini)...`;

                const base64Data = gabaritoParaProcessar.split(',')[1]; 

                const response = await fetch('/api/read_image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        base64Image: base64Data,
                        numQuestoes: NUM_QUESTOES,
                        numAlternativas: NUM_ALTERNATIVAS
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || "Erro desconhecido ao chamar a API de IA.");
                }

                respostasTemporarias = data.respostas;
                
                if (typeof respostasTemporarias !== 'object' || Object.keys(respostasTemporarias).length !== NUM_QUESTOES) {
                     throw new Error(`A IA retornou um n√∫mero incorreto de quest√µes (${Object.keys(respostasTemporarias).length} de ${NUM_QUESTOES}).`);
                }

                showConfirmationUI(alunoEmProcessamento, respostasTemporarias);

            } catch (error) {
                console.error("Erro no processamento IA:", error);
                resultadoDiv.textContent = `‚ùå Erro ao processar gabarito: ${error.message || 'Erro desconhecido'}. Tente reenviar uma nova foto.`;
                resultadoDiv.style.backgroundColor = '#f8d7da';
                resultadoDiv.style.borderColor = '#f5c6cb';
                resultadoDiv.style.color = '#721c24';
                encerrarBtn.disabled = dadosGabaritos.length === 0; 
            } finally {
                isProcessing = false;
            }
        }
        
        // --- D. L√ìGICA DE CONFIRMA√á√ÉO E REENVIO/CORRE√á√ÉO ---

        function showConfirmationUI(aluno, respostas) {
            alunoInput.disabled = true; 
            gabaritoInput.disabled = true;
            
            // Garante que a √°rea de corre√ß√£o manual esteja escondida
            correcaoManualArea.style.display = 'none'; 
            inputsCorrecaoManual.innerHTML = '';
            
            // Garante que os bot√µes normais estejam vis√≠veis e o de corre√ß√£o escondido
            confirmationButtonsRow.style.display = 'flex';
            correctionButtonsRow.style.display = 'none';
            
            // Formata as respostas em 5 colunas para visualiza√ß√£o
            const respostasLidas = Object.entries(respostas);
            let respostasFormatadas = '';
            for (let i = 0; i < respostasLidas.length; i++) {
                const [q, r] = respostasLidas[i];
                respostasFormatadas += `${q}: ${r.padEnd(2, ' ')} `;
                if ((i + 1) % 5 === 0) { 
                    respostasFormatadas += '\n'; 
                }
            }

            confirmacaoRespostasDiv.textContent = respostasFormatadas.trim();
            
            resultadoDiv.innerHTML = `‚úÖ Leitura de <strong>${aluno}</strong> conclu√≠da. <strong>Por favor, confirme as respostas.</strong>`;
            resultadoDiv.style.backgroundColor = '#fff8e1';
            resultadoDiv.style.borderColor = '#ffc107';
            resultadoDiv.style.color = '#856404';

            leituraConfirmacaoDiv.style.display = 'block';
        }

        // EVENT LISTENERS
        confirmarLeituraNormalBtn.addEventListener('click', () => confirmarLeitura(false));
        confirmarLeituraManualBtn.addEventListener('click', () => confirmarLeitura(true));
        reenviarImagemBtn.addEventListener('click', reenviarImagem);
        corrigirManualBtn.addEventListener('click', corrigirLeituraManual); 

        function corrigirLeituraManual() {
            // Esconde a visualiza√ß√£o normal
            leituraConfirmacaoDiv.style.display = 'none'; 
            
            // Esconde os bot√µes normais e mostra a √°rea de inputs
            confirmationButtonsRow.style.display = 'none';
            correcaoManualArea.style.display = 'block';
            
            inputsCorrecaoManual.innerHTML = ''; 
            correctionButtonsRow.style.display = 'flex'; // NOVO: Mostra o bot√£o Salvar/Confirmar

            const alternativasPermitidas = ['A', 'B', 'C', 'D', 'E'].slice(0, NUM_ALTERNATIVAS);
            
            Object.entries(respostasTemporarias).forEach(([questao, resposta]) => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label for="edit-${questao}" style="font-weight: bold; font-size: 0.9em;">${questao}:</label>
                    <select id="edit-${questao}" style="width: 100%; padding: 8px;">
                        <option value="">--</option>
                        ${alternativasPermitidas.map(alt => 
                            `<option value="${alt}" ${resposta === alt ? 'selected' : ''}>${alt}</option>`
                        ).join('')}
                    </select>
                `;
                inputsCorrecaoManual.appendChild(div);
            });
            
            // Volta a exibir a div de confirma√ß√£o que cont√©m a √°rea de edi√ß√£o e o bot√£o Salvar
            leituraConfirmacaoDiv.style.display = 'block';
            
            resultadoDiv.innerHTML = `‚úçÔ∏è **EDITANDO MANUALMENTE** as respostas de **${alunoEmProcessamento}**. Altere o que for necess√°rio e clique em **Salvar e Confirmar Altera√ß√µes**.`;
            resultadoDiv.style.backgroundColor = '#fff3cd'; 
            resultadoDiv.style.borderColor = '#ffc107'; 
        }

        function confirmarLeitura(isManualCorrection) {
            let respostasFinais = {};

            // 1. CHECA SE PRECISAMOS LER OS INPUTS MANUAIS
            if (isManualCorrection) {
                const selects = inputsCorrecaoManual.querySelectorAll('select');
                let preenchimentoValido = true;
                
                selects.forEach(select => {
                    const questao = select.id.replace('edit-', '');
                    if (select.value === "") {
                        preenchimentoValido = false;
                    }
                    respostasFinais[questao] = select.value;
                });
                
                if (!preenchimentoValido) {
                    alert("Erro: Por favor, preencha todas as respostas editadas antes de confirmar.");
                    return;
                }

            } else {
                // 2. SE N√ÉO FOR CORRE√á√ÉO MANUAL, USA O RESULTADO AUTOM√ÅTICO
                respostasFinais = respostasTemporarias;
            }

            // 3. REGISTRA OS DADOS
            const dadosDoAluno = {
                "Aluno": alunoEmProcessamento,
                ...Object.fromEntries(
                    Object.entries(respostasFinais).map(([k, v]) => [`Q${k.match(/\d+/)[0]}`, v])
                )
            };
            
            dadosGabaritos.push(dadosDoAluno);

            // Reseta UI para o pr√≥ximo aluno
            alunoInput.value = '';
            resetStudentInput();
            
            // Esconde a √°rea de corre√ß√£o manual ao resetar
            correcaoManualArea.style.display = 'none'; 
            inputsCorrecaoManual.innerHTML = '';
            correctionButtonsRow.style.display = 'none';

            encerrarBtn.disabled = false;
            alunosCountSpan.textContent = dadosGabaritos.length;
            
            resultadoDiv.innerHTML = `‚úÖ Gabarito de <strong>${dadosDoAluno.Aluno}</strong> registrado! Total: ${dadosGabaritos.length}. Envie o pr√≥ximo ou Encerrar.`;
            resultadoDiv.style.backgroundColor = '#d4edda';
            resultadoDiv.style.borderColor = '#c3e6cb';
            resultadoDiv.style.color = '#155724';
        }

        function reenviarImagem() {
            resetStudentInput(true); // Manter nome do aluno
            
            // Esconde a √°rea de corre√ß√£o manual ao resetar
            correcaoManualArea.style.display = 'none'; 
            inputsCorrecaoManual.innerHTML = '';
            correctionButtonsRow.style.display = 'none';
            confirmationButtonsRow.style.display = 'flex';
            
            resultadoDiv.textContent = `Reenvie a imagem do gabarito para ${alunoEmProcessamento}.`;
            resultadoDiv.style.backgroundColor = '#e9f5ff';
            resultadoDiv.style.borderColor = '#007bff';
            resultadoDiv.style.color = '#007bff';
        }
        
        function resetStudentInput(keepName = false) {
            if (!keepName) {
                alunoEmProcessamento = '';
            }
            respostasTemporarias = {};
            gabaritoInput.value = '';
            
            gabaritoPreview.style.display = 'none'; 
            
            alunoInput.disabled = false;
            gabaritoInput.disabled = false;
            
            leituraConfirmacaoDiv.style.display = 'none';
        }

        // --- E. GERA√á√ÉO DE CSV E ENCERRAMENTO ---
        encerrarBtn.addEventListener('click', function() {
            if (dadosGabaritos.length === 0) {
                 resultadoDiv.textContent = "Nenhum gabarito processado para encerrar.";
                 return;
            }
            
            gerarDownloadCSV(); 
            
            dadosGabaritos = [];
            gabaritoOficialRespostas = [];
            NUM_QUESTOES = 0;
            NUM_ALTERNATIVAS = 0;
            
            turmaInput.disabled = false;
            turmaInput.value = '';
            alunoInput.value = '';
            alunosCountSpan.textContent = '0';
            encerrarBtn.disabled = true;
            gabaritoRespostasArea.innerHTML = '';
            
            gabaritoOficialSection.style.display = 'none';
            inputSection.style.display = 'none';
            configSection.style.display = 'block';
            
            resultadoDiv.textContent = "üéâ CSV Gerado com sucesso! Aplica√ß√£o reiniciada para uma nova turma.";
            resultadoDiv.style.backgroundColor = '#fff3cd';
            resultadoDiv.style.borderColor = '#ffeeba';
            resultadoDiv.style.color = '#856404';
        });
        
        
        function gerarDownloadCSV() {
            const gabaritoOficialData = { "Aluno": "Gabarito Oficial" };
            for (let i = 1; i <= NUM_QUESTOES; i++) {
                gabaritoOficialData[`Q${i}`] = gabaritoOficialRespostas[i-1];
            }
            
            const dadosParaCSV = [gabaritoOficialData, ...dadosGabaritos];
            
            const separador = ';';
            const allKeys = new Set();
            dadosParaCSV.forEach(obj => {
                Object.keys(obj).forEach(key => allKeys.add(key));
            });
            
            const headers = ["Aluno", ...Array.from(allKeys).filter(k => k !== "Aluno").sort((a, b) => {
                const numA = parseInt(a.replace('Q', ''), 10);
                const numB = parseInt(b.replace('Q', ''), 10);
                return numA - numB;
            })];
            
            let csvString = headers.join(separador) + '\n';
            
            dadosParaCSV.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header] !== undefined ? String(row[header]) : '';
                    return `"${value.replace(/"/g, '""')}"`;
                });
                csvString += values.join(separador) + '\n';
            });
            
            const turmaNome = turmaInput.value.trim().replace(/[^a-zA-Z0-9]/g, '_');
            const data = new Date().toISOString().slice(0, 10);
            const filename = `Gabaritos_${turmaNome}_${data}.csv`;

            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>

